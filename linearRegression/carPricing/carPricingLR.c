#include <stdio.h>
#include <stdlib.h>
#include <math.h>
#define n 150
#define num_weights 4
double weigths[num_weights];
double bias[num_weights];
double data[][5] = {
    // x1,x2,x3,x4,y
    //'Year','Selling_Price','Kms_Driven','Fuel_Type','Present_Price'
    {2014, 3.35, 27000, 1, 5.590},
    {2013, 4.75, 43000, 0, 9.540},
    {2017, 7.25, 6900, 1, 9.850},
    {2011, 2.85, 5200, 1, 4.150},
    {2014, 4.60, 42450, 0, 6.870},
    {2018, 9.25, 2071, 0, 9.830},
    {2015, 6.75, 18796, 1, 8.120},
    {2015, 6.50, 33429, 0, 8.610},
    {2016, 8.75, 20273, 0, 8.890},
    {2015, 7.45, 42367, 0, 8.920},
    {2017, 2.85, 2135, 1, 3.600},
    {2015, 6.85, 51000, 0, 10.380},
    {2015, 7.50, 15000, 1, 9.940},
    {2015, 6.10, 26000, 1, 7.710},
    {2009, 2.25, 77427, 1, 7.210},
    {2016, 7.75, 43000, 0, 10.790},
    {2015, 7.25, 41678, 0, 10.790},
    {2016, 7.75, 43000, 0, 10.790},
    {2015, 3.25, 35500, 0, 5.090},
    {2010, 2.65, 41442, 1, 7.980},
    {2016, 2.85, 25000, 1, 3.950},
    {2017, 4.90, 2400, 1, 5.710},
    {2011, 4.40, 50000, 1, 8.010},
    {2014, 2.50, 45280, 1, 3.460},
    {2013, 2.90, 56879, 1, 4.410},
    {2011, 3.00, 20000, 1, 4.990},
    {2013, 4.15, 55138, 1, 5.870},
    {2017, 6.00, 16200, 1, 6.490},
    {2010, 1.95, 44542, 1, 3.950},
    {2015, 7.45, 45000, 0, 10.380},
    {2012, 3.10, 51439, 0, 5.980},
    {2011, 2.35, 54200, 1, 4.890},
    {2014, 4.95, 39000, 0, 7.490},
    {2014, 6.00, 45000, 0, 9.950},
    {2014, 5.50, 45000, 0, 8.060},
    {2011, 2.95, 49998, 0, 7.740},
    {2015, 4.65, 48767, 1, 7.200},
    {2003, 0.35, 127000, 1, 2.280},
    {2016, 3.00, 10079, 1, 3.760},
    {2003, 2.25, 62000, 1, 7.980},
    {2016, 5.85, 24524, 1, 7.870},
    {2014, 2.55, 46706, 1, 3.980},
    {2008, 1.95, 58000, 1, 7.150},
    {2014, 5.50, 45780, 0, 8.060},
    {2012, 1.25, 50000, 1, 2.690},
    {2014, 7.50, 15000, 1, 12.040},
    {2013, 2.65, 64532, 1, 4.890},
    {2006, 1.05, 65000, 1, 4.150},
    {2015, 5.80, 25870, 1, 7.710},
    {2017, 7.75, 37000, 1, 9.290},
    {2012, 14.90, 104707, 0, 30.610},
    {2015, 23.00, 40000, 0, 30.610},
    {2017, 18.00, 15000, 0, 19.770},
    {2013, 16.00, 135000, 0, 30.610},
    {2005, 2.75, 90000, 1, 10.210},
    {2009, 3.60, 70000, 1, 15.040},
    {2015, 4.50, 40534, 1, 7.270},
    {2010, 4.75, 50000, 1, 18.540},
    {2014, 4.10, 39485, 1, 6.800},
    {2014, 19.99, 41000, 0, 35.960},
    {2013, 6.95, 40001, 1, 18.610},
    {2015, 4.50, 40588, 1, 7.700},
    {2014, 18.75, 78000, 0, 35.960},
    {2015, 23.50, 47000, 0, 35.960},
    {2017, 33.00, 6000, 0, 36.230},
    {2014, 4.75, 45000, 0, 6.950},
    {2017, 19.75, 11000, 1, 23.150},
    {2010, 9.25, 59000, 0, 20.450},
    {2011, 4.35, 88000, 1, 13.740},
    {2016, 14.25, 12000, 1, 20.910},
    {2014, 3.95, 71000, 0, 6.760},
    {2011, 4.50, 45000, 0, 12.480},
    {2013, 7.45, 56001, 1, 18.610},
    {2011, 2.65, 43000, 1, 5.710},
    {2014, 4.90, 83000, 0, 8.930},
    {2015, 3.95, 36000, 1, 6.800},
    {2013, 5.50, 72000, 1, 14.680},
    {2004, 1.50, 135154, 1, 12.350},
    {2010, 5.25, 80000, 1, 22.830},
    {2012, 14.50, 89000, 0, 30.610},
    {2016, 14.73, 23000, 0, 14.890},
    {2015, 4.75, 40000, 0, 7.850},
    {2017, 23.00, 15000, 0, 25.390},
    {2015, 12.50, 38000, 0, 13.460},
    {2005, 3.49, 197176, 0, 13.460},
    {2006, 2.50, 142000, 1, 23.730},
    {2010, 35.00, 78000, 0, 92.600},
    {2012, 5.90, 56000, 1, 13.740},
    {2013, 3.45, 47000, 1, 6.050},
    {2014, 4.75, 40000, 1, 6.760},
    {2009, 3.80, 62000, 1, 18.610},
    {2014, 11.25, 58242, 0, 16.090},
    {2005, 3.51, 75000, 1, 13.700},
    {2015, 23.00, 40000, 0, 30.610},
    {2008, 4.00, 89000, 1, 22.780},
    {2012, 5.85, 72000, 1, 18.610},
    {2016, 20.75, 29000, 0, 25.390},
    {2017, 17.00, 8700, 1, 18.640},
    {2013, 7.05, 45000, 1, 18.610},
    {2010, 9.65, 50024, 0, 20.450},
    {2016, 1.75, 3000, 1, 1.900},
    {2017, 1.70, 1400, 1, 1.820},
    {2017, 1.65, 4000, 1, 1.780},
    {2017, 1.45, 1200, 1, 1.600},
    {2017, 1.35, 4100, 1, 1.470},
    {2015, 1.35, 21700, 1, 2.370},
    {2014, 1.35, 16500, 1, 3.450},
    {2013, 1.25, 15000, 1, 1.500},
    {2016, 1.20, 18000, 1, 1.500},
    {2017, 1.20, 11000, 1, 1.470},
    {2016, 1.20, 6000, 1, 1.780},
    {2016, 1.15, 8700, 1, 1.500},
    {2014, 1.15, 7000, 1, 2.400},
    {2016, 1.15, 35000, 1, 1.400},
    {2015, 1.15, 17000, 1, 1.470},
    {2015, 1.11, 17500, 1, 1.470},
    {2013, 1.10, 33000, 1, 1.470},
    {2015, 1.10, 14000, 1, 1.900},
    {2015, 1.10, 26000, 1, 1.470},
    {2013, 1.05, 5400, 1, 1.900},
    {2016, 1.05, 5700, 1, 1.260},
    {2011, 1.05, 6900, 1, 1.500},
    {2016, 1.05, 6000, 1, 1.170},
    {2013, 1.00, 46500, 1, 1.470},
    {2012, 0.95, 11500, 1, 1.750},
    {2009, 0.90, 40000, 1, 1.750},
    {2017, 0.90, 1300, 1, 0.950},
    {2016, 0.75, 7000, 1, 0.800},
    {2017, 0.80, 3000, 1, 0.870},
    {2017, 0.78, 5000, 1, 0.840},
    {2017, 0.75, 11000, 1, 0.870},
    {2015, 0.75, 18000, 1, 0.820},
    {2017, 0.75, 3500, 1, 0.950},
    {2016, 0.72, 500, 1, 0.950},
    {2017, 0.65, 11800, 1, 0.810},
    {2015, 0.65, 5000, 1, 0.740},
    {2014, 0.65, 23500, 1, 1.200},
    {2013, 0.65, 16000, 1, 0.787},
    {2016, 0.60, 15000, 1, 0.870},
    {2015, 0.60, 16600, 1, 0.950},
    {2013, 0.60, 32000, 1, 1.200},
    {2016, 0.60, 20000, 1, 0.800},
    {2015, 0.60, 29000, 1, 0.840},
    {2016, 0.60, 25000, 1, 0.840},
    {2014, 0.60, 25000, 1, 0.990},
    {2012, 0.60, 19000, 1, 0.810},
    {2014, 0.55, 15000, 1, 0.787},
    {2015, 0.55, 58000, 1, 0.840},
    {2010, 0.52, 45000, 1, 0.940},
    {2016, 0.51, 24000, 1, 0.940},
    {2011, 0.50, 6000, 1, 0.826},
    {2016, 0.50, 31000, 1, 0.550},
    {2012, 0.50, 13000, 1, 0.990},
    {2013, 0.50, 45000, 1, 0.990},
    {2014, 0.50, 8000, 1, 0.880},
    {2017, 0.48, 4300, 1, 0.510},
    {2017, 0.48, 15000, 1, 0.520},
    {2015, 0.48, 23000, 1, 0.840},
    {2017, 0.48, 8600, 1, 0.540},
    {2017, 0.45, 4000, 1, 0.510},
    {2011, 0.45, 24000, 1, 0.950},
    {2014, 0.45, 23000, 1, 0.826},
    {2012, 0.45, 14500, 1, 0.990},
    {2010, 0.45, 27000, 1, 0.950},
    {2016, 0.45, 14000, 1, 0.540},
    {2016, 0.45, 500, 1, 0.540},
    {2016, 0.45, 1000, 1, 0.550},
    {2014, 0.42, 42000, 1, 0.810},
    {2013, 0.42, 12000, 1, 0.730},
    {2015, 0.40, 14000, 1, 0.540},
    {2012, 0.40, 5500, 1, 0.830},
    {2015, 0.40, 6700, 1, 0.550},
    {2014, 0.40, 13700, 1, 0.640},
    {2017, 0.40, 1300, 1, 0.510},
    {2015, 0.38, 38600, 1, 0.720},
    {2011, 0.38, 75000, 1, 0.787},
    {2011, 0.35, 30000, 1, 1.050},
    {2016, 0.35, 24000, 1, 0.570},
    {2014, 0.35, 19000, 1, 0.520},
    {2010, 0.31, 213000, 1, 1.050},
    {2012, 0.30, 60000, 1, 0.510},
    {2016, 0.30, 50000, 1, 0.480},
    {2013, 0.30, 30000, 1, 0.580},
    {2013, 0.27, 21000, 1, 0.470},
    {2008, 0.25, 26000, 1, 0.750},
    {2008, 0.25, 1900, 1, 0.580},
    {2010, 0.25, 22000, 1, 0.520},
    {2013, 0.25, 32000, 1, 0.510},
    {2013, 0.25, 18000, 1, 0.570},
    {2005, 0.20, 55000, 1, 0.570},
    {2008, 0.20, 60000, 1, 0.750},
    {2012, 0.20, 25000, 1, 0.570},
    {2007, 0.20, 49000, 1, 0.750},
    {2013, 0.20, 24000, 1, 0.650},
    {2008, 0.20, 50000, 1, 0.787},
    {2015, 0.18, 35000, 1, 0.320},
    {2008, 0.17, 500000, 1, 0.520},
    {2010, 0.16, 33000, 1, 0.510},
    {2011, 0.15, 35000, 1, 0.570},
    {2007, 0.12, 53000, 1, 0.580},
    {2006, 0.10, 92233, 1, 0.750},
    {2010, 3.25, 58000, 0, 6.790},
    {2015, 4.40, 28200, 1, 5.700},
    {2011, 2.95, 53460, 1, 4.600},
    {2015, 2.75, 28282, 1, 4.430},
    {2016, 5.25, 3493, 1, 5.700},
    {2017, 5.75, 12479, 1, 7.130},
    {2015, 5.15, 34797, 1, 5.700},
    {2017, 7.90, 3435, 1, 8.100},
    {2015, 4.85, 21125, 0, 5.700},
    {2012, 3.10, 35775, 1, 4.600},
    {2015, 11.75, 43535, 0, 14.790},
    {2016, 11.25, 22671, 1, 13.600},
    {2011, 2.90, 31604, 1, 6.790},
    {2017, 5.25, 20114, 1, 5.700},
    {2012, 4.50, 36100, 1, 9.400},
    {2016, 2.90, 12500, 1, 4.430},
    {2016, 3.15, 15000, 1, 4.430},
    {2014, 6.45, 45078, 1, 9.400},
    {2012, 4.50, 36000, 1, 9.400},
    {2017, 3.50, 38488, 1, 4.430},
    {2013, 4.50, 32000, 1, 6.790},
    {2014, 6.00, 77632, 0, 7.600},
    {2015, 8.25, 61381, 0, 9.400},
    {2013, 5.11, 36198, 1, 9.400},
    {2011, 2.70, 22517, 1, 4.600},
    {2015, 5.25, 24678, 1, 5.700},
    {2011, 2.55, 57000, 1, 4.430},
    {2012, 4.95, 60000, 0, 9.400},
    {2012, 3.10, 52132, 0, 6.790},
    {2013, 6.15, 45000, 0, 9.400},
    {2017, 9.25, 15001, 1, 9.400},
    {2015, 11.45, 12900, 1, 14.790},
    {2013, 3.90, 53000, 0, 5.700},
    {2015, 5.50, 4492, 1, 5.700},
    {2017, 9.10, 15141, 1, 9.400},
    {2016, 3.10, 11849, 1, 4.430},
    {2015, 11.25, 68000, 0, 13.600},
    {2013, 4.80, 60241, 1, 9.400},
    {2012, 2.00, 23709, 1, 4.430},
    {2012, 5.35, 32322, 0, 9.400},
    {2015, 4.75, 35866, 1, 7.130},
    {2014, 4.40, 34000, 1, 7.130},
    {2016, 6.25, 7000, 1, 7.600},
    {2013, 5.95, 49000, 0, 9.400},
    {2012, 5.20, 71000, 0, 9.400},
    {2012, 3.75, 35000, 1, 6.790},
    {2015, 5.95, 36000, 1, 9.400},
    {2013, 4.00, 30000, 1, 4.600},
    {2016, 5.25, 17000, 1, 7.600},
    {2016, 12.90, 35934, 0, 13.600},
    {2013, 5.00, 56701, 1, 9.900},
    {2015, 5.40, 31427, 1, 6.820},
    {2014, 7.20, 48000, 0, 9.900},
    {2013, 5.25, 54242, 1, 9.900},
    {2012, 3.00, 53675, 1, 5.350},
    {2016, 10.25, 49562, 1, 13.600},
    {2015, 8.50, 40324, 1, 13.600},
    {2015, 8.40, 25000, 1, 13.600},
    {2014, 3.90, 36054, 1, 7.000},
    {2016, 9.15, 29223, 1, 13.600},
    {2016, 5.50, 5600, 1, 5.970},
    {2015, 4.00, 40023, 1, 5.800},
    {2016, 6.60, 16002, 1, 7.700},
    {2015, 4.00, 40026, 1, 7.000},
    {2017, 6.50, 21200, 1, 8.700},
    {2014, 3.65, 35000, 1, 7.000},
    {2016, 8.35, 19434, 0, 9.400},
    {2017, 4.80, 19000, 1, 5.800},
    {2015, 6.70, 18828, 1, 10.000},
    {2011, 4.10, 69341, 1, 10.000},
    {2009, 3.00, 69562, 1, 10.000},
    {2015, 7.50, 27600, 1, 10.000},
    {2010, 2.25, 61203, 1, 7.500},
    {2014, 5.30, 16500, 1, 6.800},
    {2016, 10.90, 30753, 1, 13.600},
    {2015, 8.65, 24800, 1, 13.600},
    {2015, 9.70, 21780, 1, 13.600},
    {2016, 6.00, 4000, 1, 8.400},
    {2014, 6.25, 40126, 1, 13.600},
    {2015, 5.25, 14465, 1, 5.900},
    {2006, 2.10, 50456, 1, 7.600},
    {2014, 8.25, 63000, 0, 14.000},
    {2016, 8.99, 9010, 1, 11.800},
    {2013, 3.50, 9800, 1, 5.900},
    {2016, 7.40, 15059, 1, 8.500},
    {2016, 5.65, 28569, 1, 7.900},
    {2015, 5.75, 44000, 1, 7.500},
    {2015, 8.40, 34000, 1, 13.600},
    {2016, 10.11, 10980, 1, 13.600},
    {2014, 4.50, 19000, 1, 6.400},
    {2015, 5.40, 31427, 1, 6.100},
    {2016, 6.40, 12000, 1, 8.400},
    {2010, 3.25, 38000, 1, 9.900},
    {2014, 3.75, 33019, 1, 6.800},
    {2015, 8.55, 60076, 0, 13.090},
    {2016, 9.50, 33988, 0, 11.600},
    {2015, 4.00, 60000, 1, 5.900},
    {2009, 3.35, 87934, 1, 11.000},
    {2017, 11.50, 9000, 0, 12.500},
    {2016, 5.30, 5464, 1, 5.900},

};
double gradientDescentWeight(int index)
{
    double sum = 0;
    for (int i = 0; i < n; i++)
    {
        double y = 0;
        for (int j = 0; j < num_weights; j++)
            y += ((data[i][j] * weigths[j] + bias[j]));
        sum += (data[i][num_weights] - y) * data[i][index];
    }
    sum = sum * (-2.0 / n);
    return sum;
}
double gradientDescentBias()
{
    double sum = 0;

    for (int i = 0; i < n; i++)
    {
        double y = 0;
        for (int j = 0; j < num_weights; j++)
            y += ((data[i][j] * weigths[j] + bias[j]));
        sum += (data[i][num_weights] - y);
    }
    sum = sum * (-2.0 / n);
    return sum;
}
double loss()
{
    double sum = 0;
    for (int i = 0; i < n; i++)
    {
        double y = 0;
        for (int j = 0; j < num_weights; j++)
            y += ((data[i][j] * weigths[j] + bias[j]));
        y -= data[i][num_weights];
        sum += y * y;
    }
    return sum / n;
}
void clipGradients(double *gradients, double max_norm)
{
    double total_norm = 0;
    for (int i = 0; i < num_weights; i++)
    {
        total_norm += gradients[i] * gradients[i];
    }
    total_norm = sqrt(total_norm);
    if (total_norm > max_norm)
    {
        double clip_factor = max_norm / total_norm;
        for (int i = 0; i < num_weights; i++)
        {
            gradients[i] *= clip_factor;
        }
    }
}
void initBW()
{
    for (int i = 0; i < num_weights; i++)
    {
        weigths[i] = (float)rand()/(float)RAND_MAX;
        bias[i] = (float)rand()/(float)RAND_MAX;
    }
}
int main(int argc, char const *argv[])
{
    srand(200);
    initBW();
    double lr = 1e-3;
    double max_gradient_norm = 1e-6;

    int epoch = 1e7;
    for (int i = 0; i < epoch; i++)
    {
        double dbs[num_weights];
        double dws[num_weights];
        double db = gradientDescentBias() * lr;
        for (int j = 0; j < num_weights; j++)
        {
            double dw1 = gradientDescentWeight(j) * lr;

            dbs[j] = db;
            dws[j] = dw1;
        }
        clipGradients(dws, max_gradient_norm);
        clipGradients(dbs, max_gradient_norm);
        for (int j = 0; j < num_weights; j++)
        {
            weigths[j] -= dws[j];
            bias[j] -= dbs[j];
        }
    }
    double ls = loss();
    for (int j = 0; j < num_weights; j++)
    {
        printf("w%d = %f b%d = %f\t", j + 1, weigths[j], j + 1, bias[j]);
    }
    printf("loss = %f\n", ls);
    for(int j=290;j<299;j++){
        double py=0;
        for (size_t i = 0; i < num_weights; i++)
        {
            py+=data[j][i]*weigths[i]+bias[i];
        }
        printf("Orginal Value: %f\tPredicted Value: %f\n",data[j][4],py);
    }

    return 0;
}
